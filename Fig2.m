% This script can be used to reproduce Fig. 2 in [R1] 
clear; clc;

% RF-EH data [R2]
P2110B = readmatrix('data/P2110B_overallEff@868.csv');

inRFmW = 10.^(P2110B(:,1)/10);
outDC = inRFmW.*P2110B(:,2)/100;

[~, idx] = max(P2110B(:,2));
inRFmW_ = inRFmW(idx:end);
outDC_ = outDC(idx:end);

% proposed quadratic model
a = [-0.001952 0.663 -0.01453];
quadFunc = @(a, inRFmW) a(3)*inRFmW.^2 + a(2)*inRFmW + a(1);

%% Plot results
fig = figure;
plotSettings(fig)
axisFontSize = 15;
legendFontSize = 15;

yyaxis left
plot(inRFmW, outDC, '.k', 'MarkerSize', 15); hold on
plot(inRFmW_, quadFunc(a, inRFmW_), '-', 'LineWidth', 1.5)
ylabel('$g(\varpi)$ [mW]', 'Interpreter', 'latex')

yyaxis right
plot(inRFmW, P2110B(:,2)/100, '--.', 'LineWidth', 1.5)
plot(inRFmW(idx), P2110B(idx,2)/100, 'p', 'MarkerSize', 12, 'MarkerFaceColor', 'k')
ylabel('$\eta(\varpi)$', 'Interpreter', 'latex')

% Fig. annotations
annotation('arrow',[0.274366417436352 0.273849624241484],...
    [0.655623850257542 0.809535679890056],'LineWidth',1,'HeadWidth',8,...
    'HeadLength',8);

annotation('arrow',[0.2729738735767 0.2729738735767],...
    [0.525391602281088 0.362036193892568],'LineWidth',1,'HeadWidth',8,...
    'HeadLength',8);

% Create textbox
annotation('textbox',...
    [0.134859707857462 0.5271775810486 0.274848420169146 0.113878071598477],...
    'VerticalAlignment','middle',...
    'String',{'maximum conversion','efficiency'},...
    'LineWidth',1,...
    'LineStyle','none',...
    'Interpreter','latex',...
    'HorizontalAlignment','center',...
    'FontSize',14,...
    'FitBoxToText','off');

annotation('arrow',[0.653673245614035 0.777609649122807],...
    [0.889513888888889 0.909357638888889],'LineWidth',1,'HeadWidth',8,...
    'HeadLength',8);

annotation('textbox',...
    [0.512084858308561 0.848027509234343 0.151357014420208 0.0715231775448022],...
    'VerticalAlignment','middle',...
    'String',{'saturation'},...
    'LineWidth',1,...
    'LineStyle','none',...
    'Interpreter','latex',...
    'HorizontalAlignment','center',...
    'FontSize',14,...
    'FitBoxToText','off');

hold off
grid on
xlim([0 14])
set(gca, 'TickLabelInterpreter', 'latex')
set(gca, 'Fontsize', axisFontSize)
xlabel('$\varpi$ [mW]', 'Interpreter', 'latex')

legend({'P211B RF-EH circuit', '$\tilde{g}(\varpi)$', '$\eta(\varpi)$'}, 'Location', 'southeast', ...
    'FontSize', legendFontSize, 'Interpreter', 'latex')

%% REFs
% [R1] O. M. Rosabal, et al., "Energy-Efficient Analog Beamforming for ...
% RF-WET with Charging Time Constraint", IEEE Trans. Veh. Technol. (submitted), 2023.
% [R2] https://www.powercastco.com/documentation/p2110b-module-datasheet/